# 网络基础梳理

## TCP详解

### 固定头部结构
![f8a1ad34f84f790e33055a206d006bfc](_v_images/20190324144928660_485084625.jpg)
 
**32位序号** 表示传送数据在数据流的偏移。由ISN(初始序号值)+偏移量得。  
**32位确认号** 用作对另一方发送来的TCP报文段的响应，其值位收到的TCP报文段的序号值加1。  
**4位头部长度** 单位是4字节（32bit）。所以头部的最大长度是15*4 = 60字节。  
**6位标志位**  
|     |     |
| --- | --- |
|URG |紧急指针是否有效     |
|ACK     |确认号，表示确认报文     |
|PSH     |提示应用程序应该立即从TCP接受缓存区中读走数据     |
|RST     |要求对方重新建立连接，复位报文段     |
|SYN     |请求建立连接，同步报文段     |
|FIN     |告知对方本端将关闭，结束报文段     |

**16位窗口大小** 告知对方本端TCP接受缓存区还能容纳多少字节的数据。  
**16位校验和** 发送端填充，接受端用CRC验证。  
**16位紧急指针** 紧急数据的偏移量。  

### TCP头部选项
![](_v_images/20190324152018344_96864318.png =490x)  
头部可选项最大长度40字节，具体作用往后碰到再补充。  

## TCP的建立和关闭　　

### 建立和关闭框架
#### 建立连接

![建立连接](_v_images/20190324155903749_1187293216.png =487x)
　　

#### 关闭连接
![关闭连接](_v_images/20190324155953973_1429794270.png =501x)

#### 半关闭状态
半关闭状态指机器的状态为只接受数据但不发送数据（ＡＣＫ除外），通过发送ＦＩＮ并接受到对方的FIN确认来确认可以半关闭。发送FIN确认时对方要进行read系统调用，如果返回0则说明无待接受数据，运行对方半关闭。  
### 连接超时
重新发送同步报文，具有相同的序号值。/proc/sys/net/ipv4/tcp_syn_retries定义重连次数，没次重连的时间翻倍。
### TCP状态转移
![](_v_images/20190324163326011_2081468839.png =599x)  
粗实线为典型的客户端状态转移，粗虚线为典型的客户端连接状态转移。具体状态变化如下图。  
![](_v_images/20190324163445676_2048110908.png =529x)
### TIME_WAIT状态
TIME_WAIT状态发生在**客户端**接受到服务器的FIN报文并同时发送ACK报文之后。客户端等待2  MSL时间，MSL时TCP报文在网络中生存的最大时间，文档推荐位2min。  
TIME_WAIT状态作用有两个，1.可靠的终止TCP连接。2.让从服务器迟来的TCP报文有足够的时间被识别和丢弃。  
第一个的原因是报文段7可能会抵达不到服务器，所以需要重发，客户端此时当然不能关闭。第二个的原因是，两个端口之间同时只允许一个TCP连接存在。那么假设客户端在发送报文段7之后马上 关闭，同时网络中还存在迟到的报文。此时客户端又建立同一条TCP连接，那么迟到的报文会在建立成功之后抵达，则这个报文时错误报文且具有干扰性。  

### TCP交互数据流  
交互数据流分为两种，交互数据和成块数据。交互数据包含的字节少，使用交互数据的应用程序对实时性要求高，如telnet、ssh等。成块数据常用tcp报文段允许的最大数据长度，使用成块数据的应用程序对传输效率要求高，如ftp。
#### 交互数据
注意服务端的确认是采用延迟确认的，即给客户端发送的确认收到数据报的报文是带有服务器需要返回给客户端的数据的，因为服务端处理客户端请求的任务很快。而客户端输入很慢，所以返回的确认服务端数据的报文是不带客户端数据的(length == 0)。  
在广域网中，交互数据由于有效数据长度小，所以在网络中会出现大量的tcp报文，会导致拥塞的发生。使用Nagle算法可以避免。  

#### 成块数据流
服务器以ftp传送大文件，服务器给客户端的报文数据段几乎拉满。同时客户端给服务器的确认报文中包含当前窗口还有多少，让服务器发送的总量不会超过窗口能承受的大小。  

#### 带外数据
在TCP中一次发送多个带外数据只有最后一字节被当做带外数据，此TCP报文头部将被设置为URG标志，紧急指针指向最后一个带外数据的下一个位置。注意带外缓存只有一个字节，没有及时取可能会被下一个带外字节覆盖。